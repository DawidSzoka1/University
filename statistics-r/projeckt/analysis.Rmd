---
title: "Analiza danych"
author: "Dawid Szoka"
date: "2025-04-17"
output:
   ioslides_presentation:
    widescreen: true
    smaller: true
---
## Potrzebne pakiety
Należy pobrać następujące pakiety: 
-tidyverse
-e1071
-lmtest
-ggplot2
-broom
-DT
`Dane które będziemy analizować`
```{r message=FALSE, warning=FALSE, echo=FALSE}
library(tidyverse)
library(e1071)
library(lmtest)
library(ggplot2)
library(broom)
library(DT)
set.seed(20250322)
data <- read.csv("fuel_sample.csv")
sample_data <-data %>% sample_n(100)
```
## Przykładowe dane które będziemy analizować
```{r echo=FALSE}
datatable(head(data, 5), filter="top",
          options = list(scrollX = TRUE, scrollY = "250px"))
```

```{r echo=FALSE}
opisz_liczbowa <- function(x) {
  tibble(
    typ = "numeryczna",
    mean = mean(x, na.rm = TRUE),
    sd = sd(x, na.rm = TRUE),
    min = min(x, na.rm = TRUE),
    Q1 = quantile(x, 0.25, na.rm = TRUE),
    median = median(x, na.rm = TRUE),
    Q3 = quantile(x, 0.75, na.rm = TRUE),
    max = max(x, na.rm = TRUE),
    IQR = IQR(x, na.rm = TRUE),
    skewness = skewness(x, na.rm = TRUE),
    kurtosis = kurtosis(x, na.rm = TRUE),
    moda = NA,
    n_unique = length(unique(x))
  )
}

opisz_nieliczbowa <- function(x) {
  tab <- sort(table(x), decreasing = TRUE)
  najczestsza <- names(tab)[1]
  najrzadsza <- names(tab)[length(tab)]
  tibble(
    typ = "kategoryczna",
    mean = NA,
    sd = NA,
    min = NA,
    Q1 = NA,
    median = NA,
    Q3 = NA,
    max = NA,
    IQR = NA,
    skewness = NA,
    kurtosis = NA,
    moda = najczestsza,
    freq_moda = tab[1],
    prop_moda = round(tab[1] / sum(tab), 3),
    n_unique = length(unique(x)),
    najrzadsza = najrzadsza,
    n_NA = sum(is.na(x))
  )
}

statystyki <- map_df(names(data), function(nazwa) {
  x <- data[[nazwa]]
  if (is.numeric(x)) {
    opisz_liczbowa(x) %>% mutate(zmienna = nazwa)
  } else {
    opisz_nieliczbowa(x) %>% mutate(zmienna = nazwa)
  }
})

# Przenosimy kolumnę "zmienna" na początek
statystyki <- statystyki %>% select(zmienna, typ, everything())

```
## Parametry liczbowe i pozycyjne dla każdej zmiennej
```{r echo=FALSE}
datatable(statystyki, filter="top",
          options = list(scrollX = TRUE, scrollY = "300px"))
```
## Przedziały ufności
Sprawdzenie stosowalności
```{r}
values <- na.omit(data$youSaveSpend)
n <- 40
x <- sample(values, size = n)
sh <- shapiro.test(x)
sh

```
## Wnisoek dotyczacy stosowalności przedziałów ufności

Dla zmiennej `youSaveSpend` przeprowadzono test normalności Shapiro-Wilks

- liczność próby: `r n`
- statystyka W: `r round(sh$statistic, 3)`
- wartość p: `r signif(sh$p.value, 3)`

Wartość p = `r signif(sh$p.value, 3)` jest większa niż 0.05, co oznacza, że nie ma podstaw do odrzucenia hipotezy o normalnym rozkładzie danych. Ponieważ liczność próby przekracza 30 (n = `r n`), możliwe jest stosowanie przedziału ufności dla średniej z wykorzystaniem rozkładu t-Studenta.

W związku z tym uznaje się, że przedziały ufności dla (`youSaveSpend`) są statystycznie stosowalne.

## Wyznacznie przedziałów ufności i przetestowanie hipotez `youSaveSpend`
```{r}
# Średnia
if (sh$p.value > 0.05) {
  # rozkład normalny → t-test
  t_result <- t.test(x, mu = 0)
  test_type <- "t-test"
} else {
  # brak normalności → test Wilcoxona
  t_result <- wilcox.test(x, mu = 0)
  test_type <- "test Wilcoxona"
}
ci_mean <- t_result$conf.int
p_mean <- t_result$p.value
# Mediana
y <- x + runif(length(x), min = -1e-5, max = 1e-5)
mu_val <- -5000
wilcox_result <- wilcox.test(y, mu = mu_val)
p_median <- wilcox_result$p.value
boot_median <- replicate(1000, median(sample(x, replace = TRUE)))
ci_median <- quantile(boot_median, c(0.025, 0.975))
# Wariancja
n <- length(x)
s2 <- var(x)
alpha <- 0.05
sigma0_sq <- 27500000    
chi_stat <- (n - 1) * s2 / sigma0_sq
p_value_var <- 2 * min(pchisq(chi_stat, df = n - 1), 1 - pchisq(chi_stat, df = n - 1))
ci_var <- c((n - 1) * s2 / qchisq(1 - alpha/2, df = n - 1),
            (n - 1) * s2 / qchisq(alpha/2, df = n - 1))
# Frakcja dodatnich
frakcja <- sum(x > 0)
prop_result <- prop.test(frakcja, n, p = 0.5)
ci_frac <- prop_result$conf.int
p_frac <- prop_result$p.value

```
```{r setup, include=FALSE}
wniosek_mean_test <- if (p_mean < 0.05) {
  "**Test średniej:** H₀: μ = 0 vs H₁: μ ≠ 0. Ponieważ p < 0.05, odrzucamy hipotezę zerową na rzecz alternatywnej – średnia istotnie różni się od zera. Użytkownicy przeciętnie zyskują lub tracą."
} else {
  "**Test średniej:** H₀: μ = 0 vs H₁: μ ≠ 0. Ponieważ p ≥ 0.05, brak podstaw do odrzucenia hipotezy zerowej – średnia nie różni się istotnie od zera. Użytkownicy w ujęciu średnim są neutralni finansowo."
}


wniosek_mean_ci <- if (ci_mean[1] > 0) {
  sprintf("**Przedział ufności dla średniej:** [%.2f; %.2f] – użytkownicy przeciętnie osiągają zysk.", ci_mean[1], ci_mean[2])
} else if (ci_mean[2] < 0) {
  sprintf("**Przedział ufności dla średniej:** [%.2f; %.2f] – użytkownicy przeciętnie ponoszą stratę.", ci_mean[1], ci_mean[2])
} else {
  sprintf("**Przedział ufności dla średniej:** [%.2f; %.2f] zawiera 0 – nie możemy określić jednoznacznego trendu (zysk/strata).", ci_mean[1], ci_mean[2])
}


wniosek_median_test <- if (p_median < 0.05) {
  sprintf("**Test mediany:** H₀: mediana = %d vs H₁: mediana ≠ %d. Ponieważ p < 0.05, odrzucamy hipotezę zerową na rzecz alternatywnej – mediana istotnie różni się od %d. Użytkownik przeciętny zyskuje lub traci inaczej niż zakładano.", mu_val, mu_val, mu_val)
} else {
  sprintf("**Test mediany:** H₀: mediana = %d vs H₁: mediana ≠ %d. Ponieważ p ≥ 0.05, brak podstaw do odrzucenia hipotezy zerowej – mediana nie różni się istotnie od %d. Typowy wynik użytkownika zgodny z założeniem.", mu_val, mu_val, mu_val)
}


wniosek_median_ci <- if (ci_median[1] > mu_val) {
  sprintf("**Przedział ufności dla mediany:** [%.2f; %.2f] – typowy użytkownik osiąga lepszy wynik niż %d.", ci_median[1], ci_median[2], mu_val)
} else if (ci_median[2] < mu_val) {
  sprintf("**Przedział ufności dla mediany:** [%.2f; %.2f] – typowy użytkownik osiąga gorszy wynik niż %d.", ci_median[1], ci_median[2], mu_val)
} else {
  sprintf("**Przedział ufności dla mediany:** [%.2f; %.2f] zawiera %d – nie można jednoznacznie ocenić, czy użytkownik zyskuje czy traci.", ci_median[1], ci_median[2], mu_val)
}


wniosek_var_test <- if (p_value_var < 0.05) {
  sprintf("**Test wariancji:** H₀: σ² = %.0f vs H₁: σ² ≠ %.0f. Ponieważ p < 0.05, odrzucamy hipotezę zerową na rzecz alternatywnej – wariancja istotnie różni się od %.0f. Zmienność w danych odbiega od przyjętej wartości.", sigma0_sq, sigma0_sq, sigma0_sq)
} else {
  sprintf("**Test wariancji:** H₀: σ² = %.0f vs H₁: σ² ≠ %.0f. Ponieważ p ≥ 0.05, brak podstaw do odrzucenia hipotezy zerowej – wariancja może być zgodna z %.0f. Rozrzut danych zgodny z oczekiwaniami.", sigma0_sq, sigma0_sq, sigma0_sq)
}

wniosek_var_ci <- if (ci_var[1] > sigma0_sq) {
  sprintf("**Przedział ufności dla wariancji:** [%.0f; %.0f] – rozrzut danych większy niż zakładano, użytkownicy mocno się różnią.", ci_var[1], ci_var[2])
} else if (ci_var[2] < sigma0_sq) {
  sprintf("**Przedział ufności dla wariancji:** [%.0f; %.0f] – użytkownicy są bardziej jednorodni niż przewidywano.", ci_var[1], ci_var[2])
} else {
  sprintf("**Przedział ufności dla wariancji:** [%.0f; %.0f] zawiera %.0f – zmienność danych może być zgodna z założeniem.", ci_var[1], ci_var[2], sigma0_sq)
}

wniosek_frac_test <- if (p_frac < 0.05) {
  "**Test proporcji:** H₀: p = 0.5 vs H₁: p ≠ 0.5. Ponieważ p < 0.05, odrzucamy hipotezę zerową na rzecz alternatywnej – udział osób zyskujących różni się istotnie od 50%. Jedna z grup (zyskujących/tracących) dominuje."
} else {
  "**Test proporcji:** H₀: p = 0.5 vs H₁: p ≠ 0.5. Ponieważ p ≥ 0.05, brak podstaw do odrzucenia hipotezy zerowej – udział zyskujących może wynosić 50%. Brak dominacji jednej z grup."
}



wniosek_frac_ci <- if (ci_frac[1] > 0.5) {
  sprintf("**Przedział ufności dla frakcji zyskujących:** [%.2f; %.2f] – większość użytkowników zyskuje.", ci_frac[1], ci_frac[2])
} else if (ci_frac[2] < 0.5) {
  sprintf("**Przedział ufności dla frakcji zyskujących:** [%.2f; %.2f] – większość użytkowników traci.", ci_frac[1], ci_frac[2])
} else {
  sprintf("**Przedział ufności dla frakcji zyskujących:** [%.2f; %.2f] zawiera 0.5 – nie można jednoznacznie ocenić, czy przeważają zyskujący czy tracący.", ci_frac[1], ci_frac[2])
}
```

## Średnia – t-test

**Hipotezy:**  
- H₀: μ = 0 (średnia oszczędność wynosi 0)  
- H₁: μ ≠ 0 (średnia oszczędność różna od 0)  

**Wyniki:**  
- Średnia: `r round(mean(x), 2)`  
- 95% CI: [`r round(ci_mean[1], 2)`, `r round(ci_mean[2], 2)`]
- p-value: `r round(p_mean, 10)`  

`r wniosek_mean_test`

`r wniosek_mean_ci` 


## Mediana – test Wilcoxona

**Hipotezy:**  
- H₀: mediana = `r mu_val`  
- H₁: mediana ≠ `r mu_val`

**Wyniki:**  
- Mediana: `r round(median(x), 2)`
- 95% CI:  [`r round(ci_median[1], 2)` , `r round(ci_median[2], 2)`]
- p-value: `r round(p_median, 10)`  

`r wniosek_median_test`

`r wniosek_median_ci`



## Wariancja – przedział CI
**Hipotezy:**  
- H₀: wariancja = `r  sigma0_sq`  
- H₁: wariancja ≠ `r  sigma0_sq`  

**Obliczenia dla przedziału ufności wariancji:**  
- Wariancja: `r round(s2, 2)`  
- 95% CI: [`r round(ci_var[1], 2)`, `r round(ci_var[2], 2)`] 
- p-value: `r round(p_value_var, 10)`

`r wniosek_var_test`

`r wniosek_var_ci`



## Frakcja wartości dodatnich – prop.test

**Hipotezy:**  
- H₀: p = 0.5 (proporcja dodatnich wartości = 50%)  
- H₁: p ≠ 0.5  

**Wyniki:**  
- Frakcja: `r frakcja` z `r n` (czyli `r round(frakcja/n, 2)` procent dodatnich)  
- 95% CI: [`r round(ci_frac[1], 2)`, `r round(ci_frac[2], 2)`] 
- p-value: `r round(p_frac, 10)`  

`r wniosek_frac_test`

`r wniosek_frac_ci`

## Emisja CO2 a pojemność silnika:
```{r echo=FALSE}
ggplot(
  sample_data %>% mutate(co2 = ifelse(co2 == 0, NA, co2)) %>% filter(!is.na(displ), !is.na(co2), !is.na(fuelType1)),
  aes(x = displ, y = co2, color = fuelType1)
) +
  geom_point(alpha = 0.6) +
  labs(
    title = "Emisja CO2 vs Pojemność silnika (próbka 100 aut)",
    x = "Pojemność silnika",
    y = "CO2 (g/mi)"
  ) +
  theme_minimal()
```

## Boxplot MPG miasto vs napęd

```{r echo=FALSE}
ggplot(sample_data, aes(x = drive, y = city08)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "MPG w mieście a napęd", x = "Napęd", y = "MPG miasto") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Średnia emisja CO2 w czasie
```{r echo=FALSE}
sample_data %>% filter(year >= 2012.5) %>%
  group_by(year) %>%
  summarise(średnie_CO2 = mean(co2, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = średnie_CO2)) +
  geom_line(color = "darkred", linewidth = 1.2) +
  geom_point(color = "red") +
  labs(title = "Emisja CO2 w czasie", x = "Rok", y = "CO2 (g/mi)") +
  theme_minimal()
```

## Heatmapa MPG autostrada vs cylindry i paliwo
```{r echo=FALSE}
sample_data  %>%
  group_by(cylinders, fuelType1) %>%
  summarise(śr_mpg_autostrada = mean(highway08, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = factor(cylinders), y = fuelType1, fill = śr_mpg_autostrada)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(title = "MPG autostrada wg cylindrów i paliwa", x = "Cylindry", y = "Rodzaj paliwa") +
  theme_minimal()
```

## Analiza regresji
```{r echo=FALSE}
data_clean <- data %>% filter(!is.na(city08), !is.na(displ))

## Dopasowanie modelu regresji liniowej
model <- lm(city08 ~ displ, data = data_clean)

## Podsumowanie modelu
summary(model)
```

## Interpretacja modelu:

- **Model regresji liniowej:** `city08 ~ displ`
- Współczynnik kierunkowy = -2.82 → wraz ze wzrostem pojemności silnika o 1 litr, średnie spalanie w mieście spada o ok. 2.82 mpg.
- **Wartość R² = 0.51**, co oznacza, że model wyjaśnia 51% zmienności zużycia paliwa.
- Oba współczynniki istotne statystycznie (**p < 0.05**).


## Diagnostyka reszt

```{r echo=FALSE}
shapiro.test(residuals(model))
bptest(model)
```
### Wnioski diagnostyczne:

- **Test Shapiro-Wilka**: p < 0.05 → reszty nie są rozkładem normalnym.
- **Test Breuscha-Pagana**: p < 0.05 → występuje heteroskedastyczność.
- Założenia klasycznego modelu regresji są naruszone. Możliwe konsekwencje:
  - zaniżone błędy standardowe,
  - zawyżone testy t,
  - niepewna interpretacja p-value.

---

```{r echo=FALSE, warning=FALSE}
ggplot(data_clean, aes(x = displ, y = city08)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  labs(title = "Zależność zużycia paliwa w mieście od pojemności silnika",
       x = "Pojemność silnika (litry)",
       y = "Zużycie paliwa w mieście (MPG)") +
  theme_minimal()
```



## Graficzna diagnostyka modelu

```{r echo=FALSE}
par(mfrow = c(1,2))
plot(model, which = 1, main = "Reszty vs dopasowane")
plot(model, which = 2, main = "Q-Q plot reszt")
```

- Rozrzut reszt wskazuje na **heteroskedastyczność**.
- Q-Q plot wskazuje na odchylenia od normalności (szczególnie w ogonach).



## Podsumowanie

- **Istotny negatywny związek** między `displ` a `city08`.
- Model istotny statystycznie (**p < 2.2e-16**).
- **Zastrzeżenia co do jakości modelu**:
  - Brak normalności reszt.
  - Zmienna wariancja reszt (heteroskedastyczność).

Zalecenia:

- Rozważyć transformację zmiennych (np. logarytmiczną).
- Rozważyć użycie regresji odpornych na heteroskedastyczność.
- Interpretować wartości p z ostrożnością.

## Dziękuje za uwage

Dawid Szoka
