---
title: "Analiza danych"
author: "Dawid Szoka"
date: "2025-04-17"
output:
   ioslides_presentation:
    widescreen: true
    smaller: true
---
## Potrzebne pakiety

W analizie wykorzystano następujące pakiety R:

- `tidyverse` – zestaw narzędzi do manipulacji danymi i wizualizacji  
- `e1071` – do obliczeń statystycznych (np. kurtoza, skośność)  
- `lmtest` – testowanie modeli liniowych  
- `ggplot2` – tworzenie estetycznych wykresów  
- `broom` – porządkowanie wyników modeli statystycznych  
- `DT` – interaktywne tabele

## Źródło danych

Dane użyte w niniejszym projekcie pochodzą z oficjalnej, ogólnodostępnej bazy danych dostępnej na stronie:  
[https://www.fueleconomy.gov/feg/download.shtml](https://www.fueleconomy.gov/feg/download.shtml)

Serwis ten jest prowadzony przez amerykańską **Agencję Ochrony Środowiska (EPA)** oraz **Departament Energii USA**.  
Baza zawiera szczegółowe informacje dotyczące między innymi:

- zużycia paliwa,
- emisji zanieczyszczeń,
- parametrów technicznych,
- efektywności energetycznej pojazdów sprzedawanych na rynku amerykańskim.

## Przygotowanie danych

Ze względu na dużą objętość oryginalnego zbioru danych, w projekcie wykorzystano jego losową próbkę o wielkości 2000.

Dane zostały przetworzone w następujący sposób:

**set.seed(20250322)**

**vehicles <- read.csv("vehicles.csv")**

**fuel_sample <- vehicles[sample(nrow(vehicles), 2000), ]**

**write.csv(fuel_sample, "fuel_sample.csv", row.names = FALSE)**

W dalszej części analizy wykorzystujemy tylko tę próbkę (fuel_sample),
co pozwala skrócić czas obliczeń i uprościć wizualizacje, 
zachowując reprezentatywność danych.


```{r message=FALSE, warning=FALSE, echo=FALSE}
library(tidyverse)
library(e1071)
library(lmtest)
library(ggplot2)
library(broom)
library(DT)
set.seed(20250322)
data <- read.csv("fuel_sample.csv")
sample_data <-data %>% sample_n(100)
```
## Przykładowe dane które będziemy analizować
```{r echo=FALSE}
datatable(head(data, 5), filter="top",
          options = list(scrollX = TRUE, scrollY = "250px"))
```

```{r echo=FALSE}
opisz_liczbowa <- function(x) {
  tibble(
    typ = "numeryczna",
    mean = mean(x, na.rm = TRUE),
    sd = sd(x, na.rm = TRUE),
    min = min(x, na.rm = TRUE),
    Q1 = quantile(x, 0.25, na.rm = TRUE),
    median = median(x, na.rm = TRUE),
    Q3 = quantile(x, 0.75, na.rm = TRUE),
    max = max(x, na.rm = TRUE),
    IQR = IQR(x, na.rm = TRUE),
    skewness = skewness(x, na.rm = TRUE),
    kurtosis = kurtosis(x, na.rm = TRUE),
    moda = NA,
    n_unique = length(unique(x))
  )
}

opisz_nieliczbowa <- function(x) {
  tab <- sort(table(x), decreasing = TRUE)
  najczestsza <- names(tab)[1]
  najrzadsza <- names(tab)[length(tab)]
  tibble(
    typ = "kategoryczna",
    mean = NA,
    sd = NA,
    min = NA,
    Q1 = NA,
    median = NA,
    Q3 = NA,
    max = NA,
    IQR = NA,
    skewness = NA,
    kurtosis = NA,
    moda = najczestsza,
    freq_moda = tab[1],
    prop_moda = round(tab[1] / sum(tab), 3),
    n_unique = length(unique(x)),
    najrzadsza = najrzadsza,
    n_NA = sum(is.na(x))
  )
}

statystyki <- map_df(names(data), function(nazwa) {
  x <- data[[nazwa]]
  if (is.numeric(x)) {
    opisz_liczbowa(x) %>% mutate(zmienna = nazwa)
  } else {
    opisz_nieliczbowa(x) %>% mutate(zmienna = nazwa)
  }
})

# Przenosimy kolumnę "zmienna" na początek
statystyki <- statystyki %>% select(zmienna, typ, everything())

```
## Parametry liczbowe i pozycyjne dla każdej zmiennej
```{r echo=FALSE}
datatable(statystyki, filter="top",
          options = list(scrollX = TRUE, scrollY = "300px"))
```
## Przedziały ufności
Sprawdzenie stosowalności
```{r}
values <- na.omit(data$youSaveSpend)
n <- 40
x <- sample(values, size = n)
sh <- shapiro.test(x)
sh

```
## Wnisoek dotyczacy stosowalności przedziałów ufności

Dla zmiennej `youSaveSpend` przeprowadzono test normalności Shapiro-Wilks

- liczność próby: `r n`
- statystyka W: `r round(sh$statistic, 3)`
- wartość p: `r signif(sh$p.value, 3)`

Wartość p = `r signif(sh$p.value, 3)` jest większa niż 0.05, co oznacza, że nie ma podstaw do odrzucenia hipotezy o normalnym rozkładzie danych. Ponieważ liczność próby przekracza 30 (n = `r n`), możliwe jest stosowanie przedziału ufności dla średniej z wykorzystaniem rozkładu t-Studenta.

W związku z tym uznaje się, że przedziały ufności dla średniej i wariancji zmiennej (`youSaveSpend`) są statystycznie stosowalne.

## Wyznacznie przedziałów ufności i przetestowanie hipotez `youSaveSpend`
```{r}
# Średnia
t_result <- t.test(x, mu = 0)
test_type <- "t-test"
ci_mean <- t_result$conf.int
p_mean <- t_result$p.value
# Wariancja
n <- length(x)
s2 <- var(x)
alpha <- 0.05
sigma0_sq <- 27500000    
chi_stat <- (n - 1) * s2 / sigma0_sq
p_value_var <- 2 * min(pchisq(chi_stat, df = n - 1), 1 - pchisq(chi_stat, df = n - 1))
ci_var <- c((n - 1) * s2 / qchisq(1 - alpha/2, df = n - 1),
            (n - 1) * s2 / qchisq(alpha/2, df = n - 1))
```
```{r setup, include=FALSE}
wniosek_mean_test <- if (p_mean < 0.05) {
  "**Test średniej:** H₀: μ = 0 vs H₁: μ ≠ 0. Ponieważ p < 0.05, odrzucamy hipotezę zerową na rzecz alternatywnej – średnia istotnie różni się od zera. Użytkownicy przeciętnie zyskują lub tracą."
} else {
  "**Test średniej:** H₀: μ = 0 vs H₁: μ ≠ 0. Ponieważ p ≥ 0.05, brak podstaw do odrzucenia hipotezy zerowej – średnia nie różni się istotnie od zera. Użytkownicy w ujęciu średnim są neutralni finansowo."
}


wniosek_mean_ci <- if (ci_mean[1] > 0) {
  sprintf("**Przedział ufności dla średniej:** [%.2f; %.2f] – użytkownicy przeciętnie osiągają zysk.", ci_mean[1], ci_mean[2])
} else if (ci_mean[2] < 0) {
  sprintf("**Przedział ufności dla średniej:** [%.2f; %.2f] – użytkownicy przeciętnie ponoszą stratę.", ci_mean[1], ci_mean[2])
} else {
  sprintf("**Przedział ufności dla średniej:** [%.2f; %.2f] zawiera 0 – nie możemy określić jednoznacznego trendu (zysk/strata).", ci_mean[1], ci_mean[2])
}


wniosek_var_test <- if (p_value_var < 0.05) {
  sprintf("**Test wariancji:** H₀: σ² = %.0f vs H₁: σ² ≠ %.0f. Ponieważ p < 0.05, odrzucamy hipotezę zerową na rzecz alternatywnej – wariancja istotnie różni się od %.0f. Zmienność w danych odbiega od przyjętej wartości.", sigma0_sq, sigma0_sq, sigma0_sq)
} else {
  sprintf("**Test wariancji:** H₀: σ² = %.0f vs H₁: σ² ≠ %.0f. Ponieważ p ≥ 0.05, brak podstaw do odrzucenia hipotezy zerowej – wariancja może być zgodna z %.0f. Rozrzut danych zgodny z oczekiwaniami.", sigma0_sq, sigma0_sq, sigma0_sq)
}

wniosek_var_ci <- if (ci_var[1] > sigma0_sq) {
  sprintf("**Przedział ufności dla wariancji:** [%.0f; %.0f] – rozrzut danych większy niż zakładano, użytkownicy mocno się różnią.", ci_var[1], ci_var[2])
} else if (ci_var[2] < sigma0_sq) {
  sprintf("**Przedział ufności dla wariancji:** [%.0f; %.0f] – użytkownicy są bardziej jednorodni niż przewidywano.", ci_var[1], ci_var[2])
} else {
  sprintf("**Przedział ufności dla wariancji:** [%.0f; %.0f] zawiera %.0f – zmienność danych może być zgodna z założeniem.", ci_var[1], ci_var[2], sigma0_sq)
}
```

## Średnia – t-test

**Hipotezy:**  
- H₀: μ = 0 (średnia oszczędność wynosi 0)  
- H₁: μ ≠ 0 (średnia oszczędność różna od 0)  

**Wyniki:**  

- Średnia: `r round(mean(x), 2)`  
- 95% CI: [`r round(ci_mean[1], 2)`, `r round(ci_mean[2], 2)`]
- p-value: `r round(p_mean, 10)`  

`r wniosek_mean_test`

`r wniosek_mean_ci` 

## Wariancja – przedział CI
**Hipotezy:**  
- H₀: wariancja = `r  sigma0_sq`  
- H₁: wariancja ≠ `r  sigma0_sq`  

**Obliczenia dla przedziału ufności wariancji:**

- Wariancja: `r round(s2, 2)`  
- 95% CI: [`r round(ci_var[1], 2)`, `r round(ci_var[2], 2)`] 
- p-value: `r round(p_value_var, 10)`

`r wniosek_var_test`

`r wniosek_var_ci`

## Frakcje sprawdzenie stosowalności dla `startStop`
Sprawdzamy czy zmiena `startStop` jest binarna i czy minimalna liczność sukcesów
i porażek przegracza warunki:

- liczba sukcesów >= 5
- liczba porażek >= 5

W zależności od tego zdecydujemy czy można użyć testów a jak tak to jakich.
```{r echo=FALSE}
x <- data$startStop
x[x == ""] <- NA
x <- na.omit(x)
unikalne <- unique(x)
is_binary <- length(unikalne) == 2
if (!is_binary) {
  wniosek_stosowalnosc <- "**Stosowalność testu frakcji:** Zmienna nie jest binarna – ma więcej lub mniej niż 2 unikalne wartości. Nie można zastosować testu frakcji."
} else {
  # Losuj próbkę
  x_sample <- sample(x, 100)
  tab <- table(x_sample)

  # Licz sukcesy i porażki
  success_label <- names(tab)[1]
  successes <- tab[[success_label]]
  failures <- sum(tab) - successes

  # Wniosek zależny od liczności
  if (min(successes, failures) >= 5) {
    test_type <- "prop.test"
    wniosek_stosowalnosc <- sprintf("**Stosowalność testu frakcji:** Zmienna można potraktować jako binarną TAK ponieważ ilość unikatowych wartości wynosi 2. Sukcesów: %d, porażek: %d. Obie liczby ≥ 5, więc zastosujemy **test proporcji (%s)**.", successes, failures, test_type)
  } else {
    test_type <- "binom.test"
    wniosek_stosowalnosc <- sprintf("**Stosowalność testu frakcji:**Zmienna można potraktować jako binarną TAK ponieważ ilość unikatowych wartości wynosi 2. Sukcesów: %d, porażek: %d. Przynajmniej jedna liczba < 5, więc zastosujemy **test dokładny (%s)**.", successes, failures, test_type)
  }
}
```
`r wniosek_stosowalnosc`

## Przedziały ufności i hipotezy dla frakcji zmienna `startStop`.
```{r echo=FALSE}
hipotetyczna_frakcja <- 0.5

if(test_type == "prop.test"){
  test_result <- prop.test(successes, 100, p = hipotetyczna_frakcja, correct = FALSE)
}else{
  test_result <- binom.test(successes, 100, p = hipotetyczna_frakcja)
}
p_val <- test_result$p.value
ci <- test_result$conf.int
frac_hat <- test_result$estimate
wniosek_test <- if (p_val < alpha) {
  sprintf(paste0(
    "**Test frakcji (%s):**\n",
    "Przeprowadzono test hipotezy H₀: p = %.2f przeciwko H₁: p ≠ %.2f.\n",
    "Otrzymano wartość p = %.4f, która jest mniejsza niż poziom istotności α = %.2f.\n",
    "W związku z tym odrzucamy hipotezę zerową.\n",
    "Oznacza to, że obserwowana frakcja w próbie różni się istotnie statystycznie od %.2f – udział jednej z kategorii dominuje."
  ),
  test_type, hipotetyczna_frakcja, hipotetyczna_frakcja, p_val, alpha, hipotetyczna_frakcja)
} else {
 sprintf(paste0(
  "**Test frakcji (%s):**\n",
  "Przeprowadzono test hipotezy H₀: p = %.2f przeciwko H₁: p ≠ %.2f.\n",
  "Otrzymano wartość p = %.4f, która jest większa lub równa poziomowi istotności α = %.2f.\n",
  "W związku z tym brak podstaw do odrzucenia hipotezy zerowej.\n",
  "Nie wykazano, by udział jednej z kategorii różnił się istotnie od %.1f%%."
),
test_type, hipotetyczna_frakcja, hipotetyczna_frakcja, p_val, alpha, hipotetyczna_frakcja * 100)
}

wniosek_ci <- if (hipotetyczna_frakcja < ci[1] || hipotetyczna_frakcja > ci[2]) {
  sprintf(paste0(
    "**Przedział ufności (%.0f%%):** [%.3f; %.3f]\n",
    "Ponieważ wartość %.2f nie należy do tego przedziału,\n",
    "możemy uznać, że rzeczywista frakcja populacyjna różni się od tej wartości.\n",
    "Wynik ten potwierdza odrzucenie hipotezy zerowej – udział jednej z kategorii znacząco przeważa."
  ),
  (1 - alpha)*100, ci[1], ci[2], hipotetyczna_frakcja)
} else {
  sprintf(paste0(
    "**Przedział ufności (%.0f%%):** [%.3f; %.3f]\n",
    "Ponieważ wartość %.2f należy do tego przedziału,\n",
    "nie ma podstaw do twierdzenia, że rzeczywista frakcja populacyjna różni się od %.2f.\n",
    "Wniosek: wynik testu i przedział ufności są spójne — rzeczywista frakcja może wynosić %.2f."
  ),
  (1 - alpha)*100, ci[1], ci[2], hipotetyczna_frakcja, hipotetyczna_frakcja,hipotetyczna_frakcja)
}
```
**Hipotezy:**  
- H₀: frakcja = 0.50  
- H₁: frakcja ≠ 0.50  

**Obliczenia dla przedziału ufności frakcji:**

- Frakcja: `r round(frac_hat, 4)`  
- 95% CI: [`r round(ci[1], 2)`, `r round(ci[2], 2)`] 
- p-value: `r round(p_val, 10)`

`r wniosek_test`

`r wniosek_ci`

## Emisja CO2 a pojemność silnika:
```{r echo=FALSE}
ggplot(
  sample_data %>% mutate(co2 = ifelse(co2 == 0, NA, co2)) %>% filter(!is.na(displ), !is.na(co2), !is.na(fuelType1)),
  aes(x = displ, y = co2, color = fuelType1)
) +
  geom_point(alpha = 0.6) +
  labs(
    title = "Emisja CO2 vs Pojemność silnika (próbka 100 aut)",
    x = "Pojemność silnika",
    y = "CO2 (g/mi)"
  ) +
  theme_minimal()
```

## Boxplot MPG miasto vs napęd

```{r echo=FALSE}
ggplot(sample_data, aes(x = drive, y = city08)) +
  geom_boxplot(fill = "lightblue") +
  labs(title = "MPG w mieście a napęd", x = "Napęd", y = "MPG miasto") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Średnia emisja CO2 w czasie
```{r echo=FALSE}
sample_data %>% filter(year >= 2012.5) %>%
  group_by(year) %>%
  summarise(średnie_CO2 = mean(co2, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = średnie_CO2)) +
  geom_line(color = "darkred", linewidth = 1.2) +
  geom_point(color = "red") +
  labs(title = "Emisja CO2 w czasie", x = "Rok", y = "CO2 (g/mi)") +
  theme_minimal()
```

## Heatmapa MPG autostrada vs cylindry i paliwo
```{r echo=FALSE}
sample_data  %>%
  group_by(cylinders, fuelType1) %>%
  summarise(śr_mpg_autostrada = mean(highway08, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = factor(cylinders), y = fuelType1, fill = śr_mpg_autostrada)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "blue") +
  labs(title = "MPG autostrada wg cylindrów i paliwa", x = "Cylindry", y = "Rodzaj paliwa") +
  theme_minimal()
```

## Analiza regresji
```{r echo=FALSE}
data_clean <- data %>% filter(!is.na(city08), !is.na(displ))

## Dopasowanie modelu regresji liniowej
model <- lm(city08 ~ displ, data = data_clean)

## Podsumowanie modelu
summary(model)
```

## Interpretacja modelu:

- **Model regresji liniowej:** `city08 ~ displ`
- Współczynnik kierunkowy = -2.82 → wraz ze wzrostem pojemności silnika o 1 litr, średnie spalanie w mieście spada o ok. 2.82 mpg.
- **Wartość R² = 0.51**, co oznacza, że model wyjaśnia 51% zmienności zużycia paliwa.
- Oba współczynniki istotne statystycznie (**p < 0.05**).


## Diagnostyka reszt

```{r echo=FALSE}
shapiro.test(residuals(model))
bptest(model)
```
### Wnioski diagnostyczne:

- **Test Shapiro-Wilka**: p < 0.05 → reszty nie są rozkładem normalnym.
- **Test Breuscha-Pagana**: p < 0.05 → występuje heteroskedastyczność.
- Założenia klasycznego modelu regresji są naruszone. Możliwe konsekwencje:
  - zaniżone błędy standardowe,
  - zawyżone testy t,
  - niepewna interpretacja p-value.

---

```{r echo=FALSE, warning=FALSE}
ggplot(data_clean, aes(x = displ, y = city08)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  labs(title = "Zależność zużycia paliwa w mieście od pojemności silnika",
       x = "Pojemność silnika (litry)",
       y = "Zużycie paliwa w mieście (MPG)") +
  theme_minimal()
```



## Graficzna diagnostyka modelu

```{r echo=FALSE}
par(mfrow = c(1,2))
plot(model, which = 1, main = "Reszty vs dopasowane")
plot(model, which = 2, main = "Q-Q plot reszt")
```

- Rozrzut reszt wskazuje na **heteroskedastyczność**.
- Q-Q plot wskazuje na odchylenia od normalności (szczególnie w ogonach).



## Podsumowanie

- **Istotny negatywny związek** między `displ` a `city08`.
- Model istotny statystycznie (**p < 2.2e-16**).
- **Zastrzeżenia co do jakości modelu**:
  - Brak normalności reszt.
  - Zmienna wariancja reszt (heteroskedastyczność).

Zalecenia:

- Rozważyć transformację zmiennych (np. logarytmiczną).
- Rozważyć użycie regresji odpornych na heteroskedastyczność.
- Interpretować wartości p z ostrożnością.

## Podsumowanie i wnioski

- Przeprowadzono pełną analizę statystyczną wybranej próbki danych dotyczących pojazdów.
- Obliczono parametry liczbowe i pozycyjne dla wszystkich zmiennych.
- Dla zmiennaje `youSavedSpend` wykonano:
  - przedziały ufności (średnia, mediana, wariancja, frakcja),
  - testy istotności (dla średnich, median, wariancji i frakcji),
  - analizę regresji liniowej z oceną dopasowania modelu.
- Stosowalność testów była każdorazowo weryfikowana.
- Przedstawiono co najmniej 4 wykresy ilustrujące zależności w danych.
- Wszystkie wyniki zostały zinterpretowane w kontekście statystycznym.

**Dziękuję za uwagę!**